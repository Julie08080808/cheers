<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>è½‰ç›¤åŒæ­¥æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .section {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            background: #ff00cc;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover { background: #cc0099; }
        .log {
            background: #000;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #0ff; }
        .warning { color: #ff0; }
    </style>
</head>
<body>
    <h1>ğŸ” è½‰ç›¤åŒæ­¥é™¤éŒ¯å·¥å…·</h1>

    <div class="section">
        <h2>æ­¥é©Ÿ 1: åŠ å…¥æˆ¿é–“</h2>
        <input type="text" id="playerName" placeholder="ç©å®¶åç¨±" value="æ¸¬è©¦ç©å®¶" style="padding: 10px; font-size: 16px;">
        <button onclick="joinRoom()">åŠ å…¥æˆ¿é–“</button>
        <div>æˆ‘çš„ID: <span id="myId" style="color: #0ff;">-</span></div>
    </div>

    <div class="section">
        <h2>æ­¥é©Ÿ 2: æˆ¿é–“ç‹€æ…‹ç›£æ§</h2>
        <button onclick="startMonitoring()">é–‹å§‹ç›£æ§æˆ¿é–“ç‹€æ…‹</button>
        <button onclick="stopMonitoring()">åœæ­¢ç›£æ§</button>
        <div style="margin-top: 10px;">
            <div>éŠæˆ²å·²é–‹å§‹: <span id="gameStarted" style="color: #f00;">false</span></div>
            <div>æˆ¿ä¸»ID: <span id="hostId" style="color: #0ff;">-</span></div>
            <div>æˆ‘æ˜¯æˆ¿ä¸»: <span id="isHost" style="color: #f00;">false</span></div>
            <div>ç©å®¶æ•¸é‡: <span id="playerCount" style="color: #0ff;">0</span></div>
        </div>
    </div>

    <div class="section">
        <h2>æ­¥é©Ÿ 3: è½‰ç›¤ç‹€æ…‹ç›£æ§</h2>
        <button onclick="startWheelMonitoring()">é–‹å§‹ç›£æ§è½‰ç›¤ç‹€æ…‹</button>
        <button onclick="stopWheelMonitoring()">åœæ­¢ç›£æ§</button>
        <div style="margin-top: 10px;">
            <div>è½‰ç›¤æ—‹è½‰ä¸­: <span id="wheelSpinning" style="color: #f00;">false</span></div>
            <div>è½‰ç›¤å·²å®Œæˆ: <span id="wheelFinished" style="color: #f00;">false</span></div>
            <div>éš¨æ©Ÿç¨®å­: <span id="spinSeed" style="color: #0ff;">-</span></div>
            <div>ä¸­çç´¢å¼•: <span id="winnerIndex" style="color: #0ff;">-</span></div>
        </div>
    </div>

    <div class="section">
        <h2>æ­¥é©Ÿ 4: æ‰‹å‹•æ“ä½œï¼ˆåƒ…æˆ¿ä¸»ï¼‰</h2>
        <button onclick="manualStartGame()">æˆ¿ä¸»é–‹å§‹éŠæˆ²</button>
        <button onclick="manualSpinWheel()">æˆ¿ä¸»é–‹å§‹è½‰ç›¤</button>
    </div>

    <div class="section">
        <h2>ğŸ“‹ å³æ™‚æ—¥èªŒ</h2>
        <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
        <div id="log" class="log"></div>
    </div>

    <script>
        let myPlayerId = null;
        let roomMonitorInterval = null;
        let wheelMonitorInterval = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${time}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function joinRoom() {
            const name = document.getElementById('playerName').value;
            log(`æ­£åœ¨åŠ å…¥æˆ¿é–“ï¼Œåç¨±: ${name}`, 'info');

            try {
                const response = await fetch('/api/room/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ player_name: name })
                });

                const data = await response.json();

                if (response.ok) {
                    myPlayerId = data.player_id;
                    document.getElementById('myId').textContent = myPlayerId;
                    log(`âœ… æˆåŠŸåŠ å…¥æˆ¿é–“ï¼ç©å®¶ID: ${myPlayerId}`, 'success');
                    log(`   æˆ¿ä¸»ID: ${data.room_state.host_id}`, 'info');
                    log(`   æˆ‘æ˜¯æˆ¿ä¸»: ${myPlayerId === data.room_state.host_id}`, 'info');
                } else {
                    log(`âŒ åŠ å…¥å¤±æ•—: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                log(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function checkRoomState() {
            try {
                const response = await fetch('/api/room/state', {
                    credentials: 'include'
                });

                const state = await response.json();

                document.getElementById('gameStarted').textContent = state.game_started;
                document.getElementById('gameStarted').style.color = state.game_started ? '#0f0' : '#f00';

                document.getElementById('hostId').textContent = state.host_id || '-';

                const isHost = myPlayerId && myPlayerId === state.host_id;
                document.getElementById('isHost').textContent = isHost;
                document.getElementById('isHost').style.color = isHost ? '#0f0' : '#f00';

                document.getElementById('playerCount').textContent = state.player_count;

                if (state.game_started) {
                    log(`ğŸ® éŠæˆ²å·²é–‹å§‹ï¼`, 'warning');
                }

                return state;
            } catch (error) {
                log(`âŒ æª¢æŸ¥æˆ¿é–“ç‹€æ…‹éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function checkWheelState() {
            try {
                const response = await fetch('/api/wheel/state', {
                    credentials: 'include'
                });

                const state = await response.json();

                document.getElementById('wheelSpinning').textContent = state.wheel_spinning;
                document.getElementById('wheelSpinning').style.color = state.wheel_spinning ? '#0f0' : '#f00';

                document.getElementById('wheelFinished').textContent = state.wheel_finished;
                document.getElementById('wheelFinished').style.color = state.wheel_finished ? '#0f0' : '#f00';

                document.getElementById('spinSeed').textContent = state.spin_seed || '-';
                document.getElementById('winnerIndex').textContent = state.winner_index !== null ? state.winner_index : '-';

                if (state.wheel_spinning) {
                    log(`ğŸ° è½‰ç›¤æ­£åœ¨æ—‹è½‰ï¼ç¨®å­: ${state.spin_seed}, ä¸­çç´¢å¼•: ${state.winner_index}`, 'warning');
                }

                if (state.wheel_finished) {
                    log(`âœ… è½‰ç›¤å·²å®Œæˆï¼ç©å®¶é †åº: ${JSON.stringify(state.player_order)}`, 'success');
                }

                return state;
            } catch (error) {
                log(`âŒ æª¢æŸ¥è½‰ç›¤ç‹€æ…‹éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        function startMonitoring() {
            log('ğŸ”„ é–‹å§‹ç›£æ§æˆ¿é–“ç‹€æ…‹ï¼ˆæ¯ç§’ï¼‰', 'info');
            checkRoomState();
            roomMonitorInterval = setInterval(checkRoomState, 1000);
        }

        function stopMonitoring() {
            if (roomMonitorInterval) {
                clearInterval(roomMonitorInterval);
                roomMonitorInterval = null;
                log('â¸ï¸ åœæ­¢ç›£æ§æˆ¿é–“ç‹€æ…‹', 'info');
            }
        }

        function startWheelMonitoring() {
            log('ğŸ”„ é–‹å§‹ç›£æ§è½‰ç›¤ç‹€æ…‹ï¼ˆæ¯0.5ç§’ï¼‰', 'info');
            checkWheelState();
            wheelMonitorInterval = setInterval(checkWheelState, 500);
        }

        function stopWheelMonitoring() {
            if (wheelMonitorInterval) {
                clearInterval(wheelMonitorInterval);
                wheelMonitorInterval = null;
                log('â¸ï¸ åœæ­¢ç›£æ§è½‰ç›¤ç‹€æ…‹', 'info');
            }
        }

        async function manualStartGame() {
            if (!myPlayerId) {
                log('âŒ è«‹å…ˆåŠ å…¥æˆ¿é–“', 'error');
                return;
            }

            log('ğŸ® ç™¼é€é–‹å§‹éŠæˆ²è«‹æ±‚...', 'info');

            try {
                const response = await fetch('/api/room/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_id: myPlayerId })
                });

                const data = await response.json();

                if (response.ok) {
                    log(`âœ… éŠæˆ²é–‹å§‹æˆåŠŸï¼`, 'success');
                } else {
                    log(`âŒ é–‹å§‹å¤±æ•—: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                log(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function manualSpinWheel() {
            if (!myPlayerId) {
                log('âŒ è«‹å…ˆåŠ å…¥æˆ¿é–“', 'error');
                return;
            }

            log('ğŸ° ç™¼é€è½‰ç›¤è«‹æ±‚...', 'info');

            try {
                const response = await fetch('/api/wheel/spin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_id: myPlayerId })
                });

                const data = await response.json();

                if (response.ok) {
                    log(`âœ… è½‰ç›¤é–‹å§‹ï¼ç¨®å­: ${data.spin_seed}, ä¸­çç´¢å¼•: ${data.winner_index}`, 'success');
                } else {
                    log(`âŒ è½‰ç›¤å¤±æ•—: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                log(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        log('ğŸ“± é™¤éŒ¯å·¥å…·å·²è¼‰å…¥', 'success');
        log('ğŸ‘‰ è«‹ä¾åºåŸ·è¡Œï¼š1.åŠ å…¥æˆ¿é–“ â†’ 2.é–‹å§‹ç›£æ§ â†’ 3.é–‹å§‹è½‰ç›¤ç›£æ§ â†’ 4.æ“ä½œ', 'info');
    </script>
</body>
</html>
